name: Test

on:
  push:
    branches: [main, develop, e2e]
  pull_request:
    branches: [main, develop]

jobs:
  unit-test:
    name: Unit Tests (${{ matrix.os }}-${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    # Skip on e2e branch (e2e branch only runs E2E tests)
    if: github.ref != 'refs/heads/e2e'
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            arch: amd64
            runner: ubuntu-latest
          - os: linux
            arch: arm64
            runner: ubuntu-24.04-arm
          - os: darwin
            arch: arm64
            runner: macos-14
          - os: windows
            arch: amd64
            runner: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install MinGW-w64 (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install mingw -y
          echo "C:\ProgramData\mingw64\mingw64\bin" >> $env:GITHUB_PATH
        shell: pwsh

      - name: Cache vcpkg (Windows)
        if: runner.os == 'Windows'
        uses: actions/cache@v4
        with:
          path: |
            C:/vcpkg/installed
            C:/vcpkg/packages
          key: vcpkg-windows-x64-aom-${{ hashFiles('.github/workflows/test.yml') }}
          restore-keys: |
            vcpkg-windows-x64-aom-

      - name: Install libaom via vcpkg (Windows)
        if: runner.os == 'Windows'
        run: |
          vcpkg install aom:x64-windows
          echo "PKG_CONFIG_PATH=C:/vcpkg/installed/x64-windows/lib/pkgconfig" >> $env:GITHUB_ENV
          echo "C:/vcpkg/installed/x64-windows/bin" >> $env:GITHUB_PATH
        shell: pwsh

      - name: Install dependencies and run tests (Unix)
        if: runner.os != 'Windows'
        run: |
          make deps
          make unit-test-coverage

      - name: Install dependencies and run tests (Windows)
        if: runner.os == 'Windows'
        run: |
          $env:CGO_ENABLED = "1"
          $env:CC = "gcc"
          $env:PKG_CONFIG_PATH = "C:/vcpkg/installed/x64-windows/lib/pkgconfig"
          $env:PATH = "C:/vcpkg/installed/x64-windows/bin;" + $env:PATH
          go test -v -race ./pkg/...
        shell: pwsh

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        if: matrix.os == 'linux' && matrix.arch == 'amd64'
        with:
          files: ./coverage.out
          flags: unittests
          name: codecov-umbrella

  integration-test:
    name: Integration Tests (${{ matrix.os }})
    runs-on: ${{ matrix.runner }}
    needs: unit-test
    # Skip on e2e branch (e2e branch only runs E2E tests)
    if: github.ref != 'refs/heads/e2e'
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            runner: ubuntu-latest
          - os: darwin
            runner: macos-14
          - os: windows
            runner: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install MinGW-w64 (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install mingw -y
          echo "C:\ProgramData\mingw64\mingw64\bin" >> $env:GITHUB_PATH
        shell: pwsh

      - name: Cache vcpkg (Windows)
        if: runner.os == 'Windows'
        uses: actions/cache@v4
        with:
          path: |
            C:/vcpkg/installed
            C:/vcpkg/packages
          key: vcpkg-windows-x64-aom-${{ hashFiles('.github/workflows/test.yml') }}
          restore-keys: |
            vcpkg-windows-x64-aom-

      - name: Install libaom via vcpkg (Windows)
        if: runner.os == 'Windows'
        run: |
          vcpkg install aom:x64-windows
          echo "PKG_CONFIG_PATH=C:/vcpkg/installed/x64-windows/lib/pkgconfig" >> $env:GITHUB_ENV
          echo "C:/vcpkg/installed/x64-windows/bin" >> $env:GITHUB_PATH
        shell: pwsh

      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Install dependencies and run tests (Unix)
        if: runner.os != 'Windows'
        run: |
          make deps
          make integration-test

      - name: Install dependencies and run tests (Windows)
        if: runner.os == 'Windows'
        run: |
          $env:CGO_ENABLED = "1"
          $env:CC = "gcc"
          $env:PKG_CONFIG_PATH = "C:/vcpkg/installed/x64-windows/lib/pkgconfig"
          $env:PATH = "C:/vcpkg/installed/x64-windows/bin;" + $env:PATH
          go test -v -race -tags=integration ./pkg/...
        shell: pwsh

  e2e-test:
    name: E2E Tests (${{ matrix.os }})
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 20
    # Run in parallel on main branch, or alone on e2e branch
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/e2e'
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            runner: ubuntu-latest
          - os: darwin
            runner: macos-14
          - os: windows
            runner: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install MinGW-w64 (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install mingw -y
          echo "C:\ProgramData\mingw64\mingw64\bin" >> $env:GITHUB_PATH
        shell: pwsh

      - name: Cache vcpkg (Windows)
        if: runner.os == 'Windows'
        uses: actions/cache@v4
        with:
          path: |
            C:/vcpkg/installed
            C:/vcpkg/packages
          key: vcpkg-windows-x64-aom-${{ hashFiles('.github/workflows/test.yml') }}
          restore-keys: |
            vcpkg-windows-x64-aom-

      - name: Install libaom via vcpkg (Windows)
        if: runner.os == 'Windows'
        run: |
          vcpkg install aom:x64-windows
          echo "PKG_CONFIG_PATH=C:/vcpkg/installed/x64-windows/lib/pkgconfig" >> $env:GITHUB_ENV
          echo "C:/vcpkg/installed/x64-windows/bin" >> $env:GITHUB_PATH
        shell: pwsh

      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Install dependencies and run tests (Unix)
        if: runner.os != 'Windows'
        run: |
          make deps
          make e2e-test

      - name: Install dependencies and run tests (Windows)
        if: runner.os == 'Windows'
        run: |
          $env:CGO_ENABLED = "1"
          $env:CC = "gcc"
          $env:PKG_CONFIG_PATH = "C:/vcpkg/installed/x64-windows/lib/pkgconfig"
          $env:PATH = "C:/vcpkg/installed/x64-windows/bin;" + $env:PATH
          go test -v -race -tags=e2e ./pkg/...
        shell: pwsh
